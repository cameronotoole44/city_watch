<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>nopixel watch</title>
  <link rel="icon" href="/assets/city-watch-icon.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/styles.css" />
</head>
  <body>
    <h1>city_watch</h1>
    <p class="subtitle"></p>
    <div class="search-container">
      <input 
        type="text" 
        id="search-input" 
        class="search-input" 
        placeholder="search character or streamer"
        oninput="handleSearch()"
      />
    </div>    
    <div id="app">
      <div class="loading">loading streams...</div>
    </div>

<script>
  const platformSelections = {};
const GTA_CATEGORIES = [
  "Grand Theft Auto V",
  "Grand Theft Auto V (GTA)",
  "No Pixel RP (GTA)",
];

function isInCity(stream) {
  if (stream.platform === 'both') {
    const activePlatform = platformSelections[stream.name] || 'kick';
    const platformData = activePlatform === 'kick' ? stream.kick : stream.twitch;
    return GTA_CATEGORIES.includes(platformData?.category);
  }
  return GTA_CATEGORIES.includes(stream.category);
}

  function formatDuration(startedAt) {
    const start = new Date(startedAt);
    const now = new Date();
    const diff = Math.floor((now - start) / 1000);
    const hours = Math.floor(diff / 3600);
    const minutes = Math.floor((diff % 3600) / 60);
    
    if (hours > 0) {
      return `${hours}h ${minutes}m`;
    }
    return `${minutes}m`;
  }

  function formatViewers(count) {
    if (count >= 1000) {
      return (count / 1000).toFixed(1).replace(/\.0$/, '') + 'K';
    }
    return count.toString();
  }

  function getThumbnailUrl(url, width = 320, height = 180) {
    if (!url) return '';
    return url.replace('{width}', width).replace('{height}', height);
  }

  function getStreamUrl(stream, platform) {
    if (platform === 'kick') {
      return `https://kick.com/${stream.kickUsername}`;
    }
    return `https://twitch.tv/${stream.twitchUsername}`;
  }

  function togglePlatform(streamName, newPlatform) {
    platformSelections[streamName] = newPlatform;
    const query = document.getElementById('search-input')?.value.toLowerCase().trim() || '';
    renderStreams(query);
  }

  function toggleSection(sectionId) {
    const container = document.getElementById(`${sectionId}-container`);
    const toggle = document.getElementById(`${sectionId}-toggle`);
    const isCollapsed = container.classList.toggle('collapsed');
    toggle.textContent = isCollapsed ? '+' : '‚àí';
    localStorage.setItem(`${sectionId}Collapsed`, isCollapsed);
  }

  function getSectionCollapsed(sectionId) {
    const stored = localStorage.getItem(`${sectionId}Collapsed`);
    return stored === null ? true : stored === 'true';
  }

  function handleSearch() {
    const query = document.getElementById('search-input').value.toLowerCase().trim();
    renderStreams(query);
  }

  function renderStreams(query = '') {
    const app = document.getElementById('app');
    const streams = window.currentStreams;

    if (!streams) return;

    const filtered = streams.filter(stream => {
      if (!query) return true;
      const nameMatch = stream.name.toLowerCase().includes(query);
      const characterMatch = stream.characters?.some(c => c.toLowerCase().includes(query));
      return nameMatch || characterMatch;
    });

    const inCity = filtered.filter(s => s.isLive && isInCity(s));
    const notInCity = filtered.filter(s => s.isLive && !isInCity(s));
    const offline = filtered.filter(s => !s.isLive);
    
    const notInCityCollapsed = getSectionCollapsed('notInCity');
    const offlineCollapsed = getSectionCollapsed('offline');

    let html = '';

    // IN CITY
    html += '<h2 class="section-title">in city</h2>';
    if (inCity.length > 0) {
      html += '<div class="streams-live">';
      html += inCity.map(renderLiveCard).join('');
      html += '</div>';
    } else if (query) {
      html += '<div class="empty-state"><p>no streams match "' + query + '"</p></div>';
    } else {
      html += '<div class="empty-state"><img src="/assets/pepe-hands.png" alt="" /><p>no one is in the city</p></div>';
    }

    // NOT IN CITY
    if (notInCity.length > 0) {
      html += `
        <div class="section-header">
          <h2 class="section-title">not in city (${notInCity.length})</h2>
          <button id="notInCity-toggle" class="section-toggle" onclick="toggleSection('notInCity')">
            ${notInCityCollapsed ? '+' : '‚àí'}
          </button>
        </div>
        <div id="notInCity-container" class="streams-live ${notInCityCollapsed ? 'collapsed' : ''}">
          ${notInCity.map(renderLiveCard).join('')}
        </div>
      `;
    }

    // OFFLINE
    if (offline.length > 0) {
      html += `
        <div class="section-header">
          <h2 class="section-title">offline (${offline.length})</h2>
          <button id="offline-toggle" class="section-toggle" onclick="toggleSection('offline')">
            ${offlineCollapsed ? '+' : '‚àí'}
          </button>
        </div>
        <div id="offline-container" class="streams-offline ${offlineCollapsed ? 'collapsed' : ''}">
          ${offline.map(renderOfflineCard).join('')}
        </div>
      `;
    } else if (query && streams.filter(s => !s.isLive).length > 0) {
      html += '<div class="empty-state"><p>no offline streams match "' + query + '"</p></div>';
    }

    app.innerHTML = html;
  }

  function renderLiveCard(stream) {
    const isDual = stream.platform === 'both';

    let activePlatform;
    if (isDual) {
      activePlatform = platformSelections[stream.name] || 'kick';
    } else {
      activePlatform = stream.platform || 'twitch';
    }

    let displayData;
    if (isDual) {
      displayData = activePlatform === 'kick' ? stream.kick : stream.twitch;
    } else {
      displayData = {
        title: stream.title,
        viewerCount: stream.viewerCount,
        thumbnailUrl: stream.thumbnailUrl,
        startedAt: stream.startedAt,
        category: stream.category,
      };
    }

    const hasThumbnail = displayData.thumbnailUrl && displayData.thumbnailUrl.length > 0;
    const categoryDisplay = displayData.category && !GTA_CATEGORIES.includes(displayData.category)
  ? `<span class="category-tag">${displayData.category}</span>` 
  : '';

    let badgesHtml;
    if (isDual) {
      const twitchActive = activePlatform === 'twitch';
      const kickActive = activePlatform === 'kick';
      badgesHtml = `
        <div class="platform-badges">
          <button class="platform-badge twitch ${twitchActive ? 'active' : 'inactive'}" 
                  onclick="event.preventDefault(); event.stopPropagation(); togglePlatform('${stream.name}', 'twitch')">
            twitch
          </button>
          <button class="platform-badge kick ${kickActive ? 'active' : 'inactive'}"
                  onclick="event.preventDefault(); event.stopPropagation(); togglePlatform('${stream.name}', 'kick')">
            kick
          </button>
        </div>
      `;
    } else {
      badgesHtml = `<span class="platform-badge ${activePlatform}">${activePlatform}</span>`;
    }

    return `
      <div class="stream-card live ${activePlatform}" data-streamer="${stream.name}">
        <a href="${getStreamUrl(stream, activePlatform)}" target="_blank" rel="noopener">
          <div class="card-header">
            ${badgesHtml}
            <span class="viewer-count">
              <span>üëÅ</span>
              <span>${formatViewers(displayData.viewerCount)}</span>
            </span>
          </div>              
          <div class="thumbnail-container">
            ${hasThumbnail 
              ? `<img class="thumbnail" src="${getThumbnailUrl(displayData.thumbnailUrl)}" alt="${stream.name}" loading="lazy" />`
              : `<div class="thumbnail-placeholder"><span>LIVE</span></div>`
            }
          </div>              
          <div class="streamer-name">${stream.name}</div>
          ${stream.characters?.length ? `<div class="character-name">${stream.characters.join(', ')}</div>` : ''}
          ${categoryDisplay}
          
          <div class="stream-details">
            <span class="stream-title">${displayData.title || ''}</span>
            <span class="stream-time">
              ${formatDuration(displayData.startedAt)}
              <span class="live-dot"></span>
            </span>
          </div>
        </a>
      </div>
    `;
  }

  function renderOfflineCard(stream) {
    return `
      <div class="stream-card offline">
        <div class="offline-content">
          <div class="offline-info">
            <div class="streamer-name">${stream.name}</div>
            ${stream.characters?.length ? `<div class="character-name">${stream.characters.join(', ')}</div>` : ''}
          </div>
          <span class="offline-status">Offline</span>
        </div>
      </div>
    `;
  }

  async function fetchStreams() {
    const app = document.getElementById("app");

    try {
      const response = await fetch("/api/streams");
      const streams = await response.json();

      if (streams.error) {
        throw new Error(streams.error);
      }

      window.currentStreams = streams;
      
      const query = document.getElementById('search-input')?.value.toLowerCase().trim() || '';
      renderStreams(query);
    } catch (error) {
      app.innerHTML = `<div class="error">failed to load streams: ${error.message}</div>`;
    }
  }

  fetchStreams();
  // 5 minutes
  setInterval(fetchStreams, 300000);
</script>
  </body>
</html>